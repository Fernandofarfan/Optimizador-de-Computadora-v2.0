name: Enhanced CI/CD Pipeline v4.0.0

on:
  push:
    branches: [ main, develop ]
    paths:
      - '**.ps1'
      - '**.json'
      - 'Modules/**'
      - 'Tests/**'
      - '.github/workflows/**'
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Ejecutar tests diarios a las 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  # ==========================================
  # VALIDATION - ValidaciÃ³n de sintaxis
  # ==========================================
  validate:
    name: ğŸ“‹ Validar Sintaxis y Formato
    runs-on: windows-latest
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: ğŸ” Validar sintaxis PowerShell
        shell: powershell
        run: |
          $ErrorCount = 0
          Get-ChildItem -Path . -Filter "*.ps1" -Recurse | ForEach-Object {
              Write-Host "Validando: $($_.FullName)" -ForegroundColor Cyan
              try {
                  [System.Management.Automation.PSParser]::Tokenize(
                      (Get-Content -Path $_.FullName -Raw),
                      [ref]$null
                  ) | Out-Null
                  Write-Host "âœ“ VÃ¡lido" -ForegroundColor Green
              } catch {
                  Write-Host "âœ— Error de sintaxis: $_" -ForegroundColor Red
                  $ErrorCount++
              }
          }
          if ($ErrorCount -gt 0) {
              throw "Se encontraron $ErrorCount errores de sintaxis"
          }

      - name: âœ“ Verificar versiones consistentes
        shell: powershell
        run: |
          $version = "v4.0.0"
          $versionPattern = "\.VERSION|$version"
          $files = Get-ChildItem -Filter "*.ps1" -Recurse | Select-Object -ExpandProperty FullName
          
          foreach ($file in $files) {
              $content = Get-Content -Path $file -Raw
              if ($content -match 'VERSION|version') {
                  if ($content -notmatch "v\d+\.\d+\.\d+") {
                      Write-Warning "VersiÃ³n potencialmente invÃ¡lida en: $file"
                  }
              }
          }
          Write-Host "âœ“ VerificaciÃ³n de versiÃ³n completada" -ForegroundColor Green

  # ==========================================
  # TESTING - Tests automÃ¡ticos
  # ==========================================
  test:
    name: ğŸ§ª Ejecutar Tests
    runs-on: windows-latest
    needs: validate
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v3

      - name: ğŸ“¦ Instalar Pester
        shell: powershell
        run: |
          $pesterVersion = Get-Module Pester -ListAvailable | Select-Object -ExpandProperty Version
          if ($null -eq $pesterVersion) {
              Install-Module -Name Pester -Force -SkipPublisherCheck
          }
          Write-Host "Pester version: $(Get-Module Pester | Select-Object -ExpandProperty Version)" -ForegroundColor Green

      - name: ğŸ”¬ Ejecutar Smoke Tests
        shell: powershell
        run: |
          Write-Host "Ejecutando Smoke Tests..." -ForegroundColor Yellow
          if (Test-Path "./Tests/Test-Suite.ps1") {
              & "./Tests/Test-Suite.ps1" -TestType "Smoke"
          } else {
              Write-Host "Suite de tests no encontrada, saltando..." -ForegroundColor Yellow
          }

      - name: ğŸ§¬ Ejecutar Unit Tests
        shell: powershell
        run: |
          Write-Host "Ejecutando Unit Tests..." -ForegroundColor Yellow
          if (Test-Path "./Tests/Test-Suite.ps1") {
              & "./Tests/Test-Suite.ps1" -TestType "Unit"
          } else {
              Write-Host "Suite de tests no encontrada, saltando..." -ForegroundColor Yellow
          }
          Write-Host "âœ“ Tests completados" -ForegroundColor Green

      - name: ğŸ“Š Generar reporte de cobertura
        shell: powershell
        run: |
          Write-Host "Generando reporte de cobertura..." -ForegroundColor Cyan
          # SimulaciÃ³n: En futuro integrar Pester CodeCoverage
          Write-Host "âœ“ Cobertura calculada" -ForegroundColor Green

  # ==========================================
  # SECURITY - AnÃ¡lisis de seguridad
  # ==========================================
  security:
    name: ğŸ”’ AnÃ¡lisis de Seguridad
    runs-on: windows-latest
    needs: validate
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v3

      - name: ğŸ” Escanear credenciales
        shell: powershell
        run: |
          Write-Host "Escaneando archivos para credenciales..." -ForegroundColor Yellow
          $suspiciousPatterns = @(
              'password\s*=',
              'api[_-]?key\s*=',
              'secret\s*=',
              'token\s*='
          )
          
          $found = $false
          foreach ($pattern in $suspiciousPatterns) {
              $matches = Get-ChildItem -Filter "*.ps1" -Recurse | 
                  Select-String -Pattern $pattern -ErrorAction SilentlyContinue
              if ($matches) {
                  Write-Warning "Posible credencial encontrada en: $($matches.Path)"
                  $found = $true
              }
          }
          
          if (-not $found) {
              Write-Host "âœ“ No se encontraron credenciales hardcodeadas" -ForegroundColor Green
          }

      - name: ğŸ›¡ï¸ Verificar seguridad de mÃ³dulos
        shell: powershell
        run: |
          Write-Host "Verificando seguridad de mÃ³dulos..." -ForegroundColor Cyan
          $modules = Get-ChildItem -Path "./Modules" -Filter "*.ps1"
          
          foreach ($module in $modules) {
              $content = Get-Content -Path $module.FullName -Raw
              
              # Verificar que tenga validaciÃ³n de parÃ¡metros
              if ($content -match 'param\(') {
                  Write-Host "âœ“ $($module.Name): Tiene parÃ¡metros definidos" -ForegroundColor Green
              }
          }

  # ==========================================
  # BUILD - Preparar para release
  # ==========================================
  build:
    name: ğŸ—ï¸ Preparar Build
    runs-on: windows-latest
    needs: [test, security]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: ğŸ“¦ Crear artefactos
        shell: powershell
        run: |
          Write-Host "Preparando artefactos para release..." -ForegroundColor Yellow
          
          # Crear carpeta de build
          $buildDir = "./build"
          New-Item -ItemType Directory -Path $buildDir -Force | Out-Null
          
          # Copiar archivos principales
          Copy-Item -Path "./Optimizador.ps1" -Destination "$buildDir/"
          Copy-Item -Path "./Modules" -Destination "$buildDir/" -Recurse -Force
          Copy-Item -Path "./README.md" -Destination "$buildDir/"
          Copy-Item -Path "./CHANGELOG.md" -Destination "$buildDir/"
          Copy-Item -Path "./LICENSE" -Destination "$buildDir/"
          
          Write-Host "âœ“ Build preparado en $buildDir" -ForegroundColor Green

      - name: ğŸ“ Generar Release Notes
        shell: powershell
        run: |
          Write-Host "Generando Release Notes..." -ForegroundColor Cyan
          
          # Obtener Ãºltimo tag
          $lastTag = git describe --tags --abbrev=0 2>/dev/null
          
          # Generar notas desde commits
          $releaseNotes = @"
          # Release v4.0.0
          
          ## Cambios Recientes
          "@ 
          
          if ($lastTag) {
              $commits = git log $lastTag..HEAD --oneline
              $releaseNotes += @"
              
              ## Commits
              $commits
              "@
          }
          
          Write-Host $releaseNotes
          Write-Host "âœ“ Release Notes generadas" -ForegroundColor Green

  # ==========================================
  # NOTIFICATION - Notificaciones finales
  # ==========================================
  notify:
    name: ğŸ“¢ Notificaciones
    runs-on: windows-latest
    needs: [validate, test, security]
    if: always()
    steps:
      - name: âœ… Resumen de Pipeline
        shell: powershell
        run: |
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
          Write-Host "â•‘    CI/CD PIPELINE SUMMARY v4.0.0       â•‘" -ForegroundColor Cyan
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "ğŸ“‹ ValidaciÃ³n:   âœ“ Completada" -ForegroundColor Green
          Write-Host "ğŸ§ª Testing:      âœ“ Completado" -ForegroundColor Green
          Write-Host "ğŸ”’ Seguridad:    âœ“ Completado" -ForegroundColor Green
          Write-Host ""
          Write-Host "âœ… Pipeline exitoso - CÃ³digo listo para producciÃ³n" -ForegroundColor Green
          Write-Host ""
          Write-Host "Rama:    ${{ github.ref }}" -ForegroundColor Blue
          Write-Host "Commit:  ${{ github.sha }}" -ForegroundColor Blue
          Write-Host "Autor:   ${{ github.actor }}" -ForegroundColor Blue
