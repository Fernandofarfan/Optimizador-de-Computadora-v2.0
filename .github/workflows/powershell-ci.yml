name: PowerShell CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  analyze:
    name: PSScriptAnalyzer
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install PSScriptAnalyzer
        shell: pwsh
        run: |
          Set-PSRepository PSGallery -InstallationPolicy Trusted
          Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser

      - name: Run PSScriptAnalyzer
        shell: pwsh
        run: |
          $results = Invoke-ScriptAnalyzer -Path . -Recurse -Settings .PSScriptAnalyzerSettings.psd1 -ReportSummary
          $errors = $results | Where-Object { $_.Severity -eq 'Error' }
          $warnings = $results | Where-Object { $_.Severity -eq 'Warning' }
          
          Write-Host "‚úÖ Analysis complete"
          Write-Host "Errors: $($errors.Count)"
          Write-Host "Warnings: $($warnings.Count)"
          
          if ($errors.Count -gt 0) {
            $errors | Format-Table -AutoSize
            exit 1
          }

  test:
    name: Pester Tests
    runs-on: windows-latest
    needs: analyze
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Pester
        shell: pwsh
        run: |
          Set-PSRepository PSGallery -InstallationPolicy Trusted
          Install-Module -Name Pester -MinimumVersion 5.0.0 -Force -Scope CurrentUser

      - name: Run Unit Tests
        shell: pwsh
        run: |
          $config = New-PesterConfiguration
          $config.Run.Path = './tests/Unit'
          $config.Run.PassThru = $true
          $config.CodeCoverage.Enabled = $true
          $config.CodeCoverage.Path = '*.ps1'
          $config.CodeCoverage.OutputFormat = 'JaCoCo'
          $config.CodeCoverage.OutputPath = './coverage.xml'
          $config.Output.Verbosity = 'Detailed'
          
          $result = Invoke-Pester -Configuration $config
          
          if ($result.FailedCount -gt 0) {
            Write-Host "‚ùå $($result.FailedCount) tests failed"
            exit 1
          }
          
          Write-Host "‚úÖ All $($result.PassedCount) tests passed"
          Write-Host "üìä Code Coverage: $($result.CodeCoverage.CoveragePercent)%"

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  integration-test:
    name: Integration Tests
    runs-on: windows-latest
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Pester
        shell: pwsh
        run: |
          Set-PSRepository PSGallery -InstallationPolicy Trusted
          Install-Module -Name Pester -MinimumVersion 5.0.0 -Force -Scope CurrentUser

      - name: Run Integration Tests
        shell: pwsh
        run: |
          $config = New-PesterConfiguration
          $config.Run.Path = './tests/Integration'
          $config.Run.PassThru = $true
          $config.Output.Verbosity = 'Detailed'
          
          $result = Invoke-Pester -Configuration $config
          
          if ($result.FailedCount -gt 0) {
            exit 1
          }

  powershell-validation:
    name: Validaci√≥n de Scripts PowerShell
    runs-on: windows-latest
    
    steps:
    - name: Checkout c√≥digo
      uses: actions/checkout@v4
      
    - name: Validar sintaxis de PowerShell
      shell: pwsh
      run: |
        Write-Host "Validando sintaxis de todos los scripts PowerShell..." -ForegroundColor Cyan
        
        $scripts = Get-ChildItem -Path . -Filter "*.ps1" -Recurse | Where-Object { $_.DirectoryName -notlike "*\.git*" }
        $errors = 0
        
        foreach ($script in $scripts) {
            Write-Host "`nValidando: $($script.Name)" -ForegroundColor Yellow
            
            $content = Get-Content -Path $script.FullName -Raw -ErrorAction SilentlyContinue
            
            if (-not $content) {
                Write-Host "  ‚ö†Ô∏è  Advertencia: Archivo vac√≠o" -ForegroundColor Yellow
                continue
            }
            
            $syntaxErrors = $null
            $null = [System.Management.Automation.PSParser]::Tokenize($content, [ref]$syntaxErrors)
            
            if ($syntaxErrors.Count -gt 0) {
                Write-Host "  ‚ùå ERROR: Sintaxis inv√°lida" -ForegroundColor Red
                foreach ($error in $syntaxErrors) {
                    Write-Host "    L√≠nea $($error.Token.StartLine): $($error.Message)" -ForegroundColor Red
                }
                $errors++
            } else {
                Write-Host "  ‚úÖ Sintaxis v√°lida" -ForegroundColor Green
            }
        }
        
        Write-Host "`n========================================" -ForegroundColor Cyan
        if ($errors -eq 0) {
            Write-Host "‚úÖ Todos los scripts pasaron la validaci√≥n" -ForegroundColor Green
            exit 0
        } else {
            Write-Host "‚ùå $errors script(s) con errores de sintaxis" -ForegroundColor Red
            exit 1
        }
    
    - name: Verificar estructura del proyecto
      shell: pwsh
      run: |
        Write-Host "Verificando estructura del proyecto..." -ForegroundColor Cyan
        
        $requiredFiles = @(
            "Optimizador.ps1",
            "Analizar-Sistema.ps1",
            "Optimizar-Sistema-Seguro.ps1",
            "Limpieza-Profunda.ps1",
            "Optimizar-Servicios.ps1",
            "Gestionar-Procesos.ps1",
            "Reparar-Red-Sistema.ps1",
            "EJECUTAR-COMO-ADMIN.bat",
            "README.md",
            "LICENSE",
            "CHANGELOG.md"
        )
        
        $missing = @()
        foreach ($file in $requiredFiles) {
            if (-not (Test-Path $file)) {
                $missing += $file
            }
        }
        
        if ($missing.Count -gt 0) {
            Write-Host "‚ùå Archivos faltantes:" -ForegroundColor Red
            $missing | ForEach-Object { Write-Host "  - $_" -ForegroundColor Red }
            exit 1
        } else {
            Write-Host "‚úÖ Todos los archivos requeridos est√°n presentes" -ForegroundColor Green
        }
    
    - name: Verificar formato del c√≥digo
      shell: pwsh
      run: |
        Write-Host "Verificando formato del c√≥digo..." -ForegroundColor Cyan
        
        $scripts = Get-ChildItem -Path . -Filter "*.ps1" -Recurse | Where-Object { $_.DirectoryName -notlike "*\.git*" }
        $warnings = 0
        
        foreach ($script in $scripts) {
            $content = Get-Content -Path $script.FullName -Raw
            
            # Verificar BOM UTF-8
            if ($content -match '^\xEF\xBB\xBF') {
                Write-Host "‚ö†Ô∏è  $($script.Name): Contiene BOM UTF-8" -ForegroundColor Yellow
                $warnings++
            }
            
            # Verificar tabs vs espacios
            if ($content -match '\t') {
                Write-Host "‚ö†Ô∏è  $($script.Name): Usa tabs en lugar de espacios" -ForegroundColor Yellow
                $warnings++
            }
            
            # Verificar l√≠neas muy largas (>150 caracteres)
            $lines = $content -split "`n"
            $longLines = $lines | Where-Object { $_.Length -gt 150 }
            if ($longLines.Count -gt 0) {
                Write-Host "‚ö†Ô∏è  $($script.Name): $($longLines.Count) l√≠nea(s) mayor(es) a 150 caracteres" -ForegroundColor Yellow
                $warnings++
            }
        }
        
        Write-Host "`n========================================" -ForegroundColor Cyan
        if ($warnings -eq 0) {
            Write-Host "‚úÖ Formato del c√≥digo correcto" -ForegroundColor Green
        } else {
            Write-Host "‚ö†Ô∏è  $warnings advertencia(s) de formato encontradas" -ForegroundColor Yellow
        }
