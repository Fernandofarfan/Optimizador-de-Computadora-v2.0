name: Create Release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  release:
    name: Create GitHub Release
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install ps2exe module
        shell: pwsh
        run: |
          Write-Host "Installing ps2exe from PowerShell Gallery..." -ForegroundColor Cyan
          try {
            Install-Module -Name ps2exe -Force -Scope CurrentUser -AllowClobber -SkipPublisherCheck
          } catch {
            Write-Warning "ps2exe installation warning: $_"
          }

      - name: Build EXE from Optimizador.ps1
        shell: pwsh
        run: |
          Write-Host "Building Optimizador.exe using ps2exe..." -ForegroundColor Cyan
          $input = Join-Path $PWD "Optimizador.ps1"
          $output = Join-Path $PWD "Optimizador.exe"
          if (Test-Path $input) {
            # Icon optional
            $icon = Join-Path $PWD "docs\icon.ico"
            if (Test-Path $icon) {
              Invoke-ps2exe -inputFile $input -outputFile $output -title "Optimizador de Computadora" -icon $icon
            } else {
              Invoke-ps2exe -inputFile $input -outputFile $output -title "Optimizador de Computadora"
            }
            if (Test-Path $output) {
              Write-Host "Built EXE: $output" -ForegroundColor Green
            } else {
              Write-Error "Failed to build EXE"
            }
          } else {
            Write-Error "Optimizador.ps1 not found"
          }

      - name: Get version from tag
        id: get_version
        shell: pwsh
        run: |
          $tag = "${{ github.ref }}" -replace 'refs/tags/', ''
          $version = $tag -replace 'v', ''
          echo "version=$version" >> $env:GITHUB_OUTPUT
          echo "tag=$tag" >> $env:GITHUB_OUTPUT

      - name: Extract changelog for version
        id: changelog
        shell: pwsh
        run: |
          $version = "${{ steps.get_version.outputs.version }}"
          $changelog = Get-Content -Path CHANGELOG.md -Raw
          
          # Extract section for this version
          if ($changelog -match "(?s)## \[$version\].*?(?=\n## \[|\z)") {
            $notes = $matches[0]
          } else {
            $notes = "Release $version"
          }
          
          $notes | Out-File -FilePath release_notes.txt -Encoding UTF8
          Get-Content release_notes.txt

      - name: Create Release Package
        shell: pwsh
        run: |
          $version = "${{ steps.get_version.outputs.version }}"
          $archiveName = "Optimizador-PC-v$version.zip"
          
          # Crear estructura limpia
          $releaseDir = "release-temp"
          New-Item -ItemType Directory -Path $releaseDir -Force | Out-Null
          
          # Copiar archivos esenciales
          $include = @(
            'Optimizador.ps1',
            'Optimizador.exe',
            'EJECUTAR-COMO-ADMIN.bat',
            'Instalar.ps1',
            '*.ps1',
            'config.default.json',
            'README.md',
            'LICENSE',
            'CHANGELOG.md',
            'docs/'
          )
          
          foreach ($pattern in $include) {
            Get-ChildItem -Path $pattern -Recurse -ErrorAction SilentlyContinue | 
              Copy-Item -Destination { Join-Path $releaseDir $_.FullName.Substring($PWD.Path.Length + 1) } -Force
          }
          
          # Crear ZIP
          Compress-Archive -Path "$releaseDir\*" -DestinationPath $archiveName -Force
          
          Remove-Item -Path $releaseDir -Recurse -Force
          
          Write-Host "âœ… Created $archiveName"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: "Optimizador de PC v${{ steps.get_version.outputs.version }}"
          body_path: release_notes.txt
          files: |
            Optimizador-PC-v${{ steps.get_version.outputs.version }}.zip
            Optimizador.exe
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
