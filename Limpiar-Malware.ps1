# ============================================
# Limpiar-Malware.ps1
# Detecci√≥n y limpieza de PUPs, adware y malware com√∫n
# ============================================

$ErrorActionPreference = 'SilentlyContinue'
$scriptPath = Split-Path -Parent $MyInvocation.MyCommand.Definition
Set-Location -Path $scriptPath

. "$scriptPath\Logger.ps1"
Initialize-Logger

Write-Host ""
Write-Host "========================================" -ForegroundColor Cyan
Write-Host "LIMPIEZA DE MALWARE Y ADWARE" -ForegroundColor Cyan
Write-Host "========================================" -ForegroundColor Cyan
Write-Host ""

Write-Log "Iniciando an√°lisis de malware/adware" -Level "INFO"

$threatsFound = 0
$itemsCleaned = 0

# ============================================
# 1. VERIFICAR HOSTS FILE
# ============================================

Write-Host "[1/7] Analizando archivo HOSTS..." -ForegroundColor Cyan

$hostsPath = "$env:SystemRoot\System32\drivers\etc\hosts"
$hostsBackup = "$scriptPath\hosts.backup-$(Get-Date -Format 'yyyyMMdd-HHmmss')"

try {
    $hostsContent = Get-Content $hostsPath
    $suspiciousLines = $hostsContent | Where-Object { 
        $_ -notmatch "^\s*#" -and 
        $_ -match "\S" -and
        $_ -notmatch "^127\.0\.0\.1\s+localhost" -and
        $_ -notmatch "^::1\s+localhost"
    }
    
    if ($suspiciousLines.Count -gt 0) {
        Write-Host "  ‚ö†Ô∏è  Encontradas $($suspiciousLines.Count) entradas sospechosas en HOSTS" -ForegroundColor Yellow
        Write-Host ""
        foreach ($line in $suspiciousLines) {
            Write-Host "     $line" -ForegroundColor Red
            $threatsFound++
        }
        
        Write-Host ""
        $clean = Read-Host "  ¬øLimpiar archivo HOSTS? (S/N)"
        if ($clean -eq 'S' -or $clean -eq 's') {
            # Backup
            Copy-Item $hostsPath $hostsBackup -Force
            
            # Limpiar
            $cleanContent = @(
                "# Copyright (c) 1993-2009 Microsoft Corp."
                "#"
                "# This is a sample HOSTS file used by Microsoft TCP/IP for Windows."
                "#"
                "# localhost name resolution is handled within DNS itself."
                "127.0.0.1       localhost"
                "::1             localhost"
            )
            
            Set-Content -Path $hostsPath -Value $cleanContent -Encoding ASCII -Force
            Write-Host "  ‚úÖ Archivo HOSTS limpiado (backup: hosts.backup)" -ForegroundColor Green
            Write-Log "Archivo HOSTS limpiado" -Level "SUCCESS"
            $itemsCleaned++
        }
    } else {
        Write-Host "  ‚úÖ Archivo HOSTS limpio" -ForegroundColor Green
    }
} catch {
    Write-Host "  ‚ö†Ô∏è  No se pudo verificar archivo HOSTS" -ForegroundColor Yellow
    Write-Log "Error al verificar HOSTS: $($_.Exception.Message)" -Level "WARNING"
}

Write-Host ""

# ============================================
# 2. TAREAS PROGRAMADAS SOSPECHOSAS
# ============================================

Write-Host "[2/7] Buscando tareas programadas sospechosas..." -ForegroundColor Cyan

$suspiciousTasks = @()
$knownBadTasks = @(
    "*update*checker*", "*adware*", "*toolbar*", "*browser*helper*",
    "*coupon*", "*deal*", "*shopping*", "*optimizer*unknown*"
)

try {
    $allTasks = Get-ScheduledTask | Where-Object { $_.State -ne "Disabled" }
    
    foreach ($task in $allTasks) {
        $taskName = $task.TaskName.ToLower()
        $taskPath = $task.TaskPath.ToLower()
        
        foreach ($pattern in $knownBadTasks) {
            if ($taskName -like $pattern -or $taskPath -like $pattern) {
                $suspiciousTasks += $task
                break
            }
        }
    }
    
    if ($suspiciousTasks.Count -gt 0) {
        Write-Host "  ‚ö†Ô∏è  Encontradas $($suspiciousTasks.Count) tareas sospechosas:" -ForegroundColor Yellow
        Write-Host ""
        
        foreach ($task in $suspiciousTasks) {
            Write-Host "     ‚Ä¢ $($task.TaskName) - $($task.TaskPath)" -ForegroundColor Red
            $threatsFound++
        }
        
        Write-Host ""
        $clean = Read-Host "  ¬øDeshabilitar estas tareas? (S/N)"
        if ($clean -eq 'S' -or $clean -eq 's') {
            foreach ($task in $suspiciousTasks) {
                try {
                    Disable-ScheduledTask -TaskName $task.TaskName -TaskPath $task.TaskPath -ErrorAction Stop | Out-Null
                    Write-Host "  ‚úÖ Deshabilitada: $($task.TaskName)" -ForegroundColor Green
                    $itemsCleaned++
                } catch {
                    Write-Host "  ‚ö†Ô∏è  Error al deshabilitar: $($task.TaskName)" -ForegroundColor Yellow
                }
            }
            Write-Log "Tareas sospechosas deshabilitadas: $itemsCleaned" -Level "SUCCESS"
        }
    } else {
        Write-Host "  ‚úÖ No se encontraron tareas sospechosas" -ForegroundColor Green
    }
} catch {
    Write-Host "  ‚ö†Ô∏è  No se pudo verificar tareas programadas" -ForegroundColor Yellow
}

Write-Host ""

# ============================================
# 3. EXTENSIONES DE NAVEGADOR (Chrome)
# ============================================

Write-Host "[3/7] Analizando extensiones de Chrome..." -ForegroundColor Cyan

$chromeExtensionsPath = "$env:LOCALAPPDATA\Google\Chrome\User Data\Default\Extensions"

if (Test-Path $chromeExtensionsPath) {
    try {
        $extensions = Get-ChildItem $chromeExtensionsPath -Directory
        
        # Lista de IDs de extensiones maliciosas conocidas (ejemplos)
        $knownBadExtensions = @(
            "extensionid1", "extensionid2"  # IDs de ejemplo
        )
        
        Write-Host "  ‚ÑπÔ∏è  Extensiones instaladas: $($extensions.Count)" -ForegroundColor White
        
        $suspicious = 0
        foreach ($ext in $extensions) {
            if ($knownBadExtensions -contains $ext.Name) {
                Write-Host "  ‚ö†Ô∏è  Extensi√≥n sospechosa: $($ext.Name)" -ForegroundColor Yellow
                $suspicious++
                $threatsFound++
            }
        }
        
        if ($suspicious -eq 0) {
            Write-Host "  ‚úÖ No se detectaron extensiones maliciosas conocidas" -ForegroundColor Green
        }
        
        Write-Host "  ‚ÑπÔ∏è  Revisa manualmente en chrome://extensions" -ForegroundColor Gray
        
    } catch {
        Write-Host "  ‚ö†Ô∏è  Error al analizar extensiones" -ForegroundColor Yellow
    }
} else {
    Write-Host "  ‚ÑπÔ∏è  Chrome no instalado o sin extensiones" -ForegroundColor Gray
}

Write-Host ""

# ============================================
# 4. PROGRAMAS SOSPECHOSOS
# ============================================

Write-Host "[4/7] Buscando programas sospechosos instalados..." -ForegroundColor Cyan

$knownPUPs = @(
    "*toolbar*", "*coupon*", "*shophelper*", "*adware*", 
    "*searchprotect*", "*browsefox*", "*optimizer*pro*",
    "*pckeeper*", "*driverupdate*", "*registry*clean*",
    "*speedup*mypc*", "*advanced*systemcare*free*"
)

try {
    $installedPrograms = Get-ItemProperty HKLM:\Software\Microsoft\Windows\CurrentVersion\Uninstall\* |
                        Select-Object DisplayName, Publisher, InstallDate
    
    $installedPrograms += Get-ItemProperty HKLM:\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\Uninstall\* |
                         Select-Object DisplayName, Publisher, InstallDate
    
    $suspiciousPrograms = @()
    
    foreach ($program in $installedPrograms) {
        if ($program.DisplayName) {
            $name = $program.DisplayName.ToLower()
            foreach ($pattern in $knownPUPs) {
                if ($name -like $pattern) {
                    $suspiciousPrograms += $program
                    break
                }
            }
        }
    }
    
    if ($suspiciousPrograms.Count -gt 0) {
        Write-Host "  ‚ö†Ô∏è  Encontrados $($suspiciousPrograms.Count) programas potencialmente no deseados:" -ForegroundColor Yellow
        Write-Host ""
        
        foreach ($prog in $suspiciousPrograms) {
            Write-Host "     ‚Ä¢ $($prog.DisplayName) - $($prog.Publisher)" -ForegroundColor Red
            $threatsFound++
        }
        
        Write-Host ""
        Write-Host "  ‚ÑπÔ∏è  Desinstala manualmente desde Configuraci√≥n > Aplicaciones" -ForegroundColor Yellow
        
    } else {
        Write-Host "  ‚úÖ No se encontraron programas sospechosos conocidos" -ForegroundColor Green
    }
} catch {
    Write-Host "  ‚ö†Ô∏è  Error al analizar programas instalados" -ForegroundColor Yellow
}

Write-Host ""

# ============================================
# 5. CARPETAS DE TEMP SOSPECHOSAS
# ============================================

Write-Host "[5/7] Analizando carpetas temporales..." -ForegroundColor Cyan

$suspiciousFolders = @(
    "$env:TEMP\*.exe",
    "$env:TEMP\*.bat",
    "$env:TEMP\*.vbs",
    "$env:TEMP\*.js",
    "$env:APPDATA\*.exe"
)

$foundScripts = 0

foreach ($pattern in $suspiciousFolders) {
    $items = Get-ChildItem $pattern -ErrorAction SilentlyContinue
    if ($items) {
        foreach ($item in $items) {
            # Verificar si es reciente (√∫ltimas 24 horas)
            if ((Get-Date) - $item.LastWriteTime -lt (New-TimeSpan -Hours 24)) {
                Write-Host "  ‚ö†Ô∏è  Archivo sospechoso reciente: $($item.Name)" -ForegroundColor Yellow
                $foundScripts++
                $threatsFound++
            }
        }
    }
}

if ($foundScripts -eq 0) {
    Write-Host "  ‚úÖ No se encontraron archivos ejecutables sospechosos" -ForegroundColor Green
} else {
    Write-Host "  ‚ÑπÔ∏è  Revisa manualmente la carpeta TEMP" -ForegroundColor Yellow
}

Write-Host ""

# ============================================
# 6. PROCESOS SOSPECHOSOS
# ============================================

Write-Host "[6/7] Analizando procesos en ejecuci√≥n..." -ForegroundColor Cyan

$knownBadProcesses = @(
    "adware", "toolbar", "mindspark", "coupon", "deal",
    "searchprotect", "browsefox", "conduit", "babylon"
)

$suspiciousProcesses = @()

try {
    $processes = Get-Process | Where-Object { $_.Company -ne "Microsoft Corporation" }
    
    foreach ($proc in $processes) {
        $procName = $proc.ProcessName.ToLower()
        foreach ($badName in $knownBadProcesses) {
            if ($procName -like "*$badName*") {
                $suspiciousProcesses += $proc
                break
            }
        }
    }
    
    if ($suspiciousProcesses.Count -gt 0) {
        Write-Host "  ‚ö†Ô∏è  Procesos sospechosos en ejecuci√≥n:" -ForegroundColor Yellow
        Write-Host ""
        
        foreach ($proc in $suspiciousProcesses) {
            Write-Host "     ‚Ä¢ $($proc.ProcessName) - $($proc.Company)" -ForegroundColor Red
            $threatsFound++
        }
        
        Write-Host ""
        $clean = Read-Host "  ¬øDetener estos procesos? (S/N)"
        if ($clean -eq 'S' -or $clean -eq 's') {
            foreach ($proc in $suspiciousProcesses) {
                try {
                    Stop-Process -Id $proc.Id -Force -ErrorAction Stop
                    Write-Host "  ‚úÖ Detenido: $($proc.ProcessName)" -ForegroundColor Green
                    $itemsCleaned++
                } catch {
                    Write-Host "  ‚ö†Ô∏è  Error al detener: $($proc.ProcessName)" -ForegroundColor Yellow
                }
            }
            Write-Log "Procesos sospechosos detenidos: $itemsCleaned" -Level "SUCCESS"
        }
    } else {
        Write-Host "  ‚úÖ No se encontraron procesos sospechosos" -ForegroundColor Green
    }
} catch {
    Write-Host "  ‚ö†Ô∏è  Error al analizar procesos" -ForegroundColor Yellow
}

Write-Host ""

# ============================================
# 7. WINDOWS DEFENDER SCAN
# ============================================

Write-Host "[7/7] Ejecutando escaneo r√°pido de Windows Defender..." -ForegroundColor Cyan

try {
    $defenderStatus = Get-MpComputerStatus
    
    if ($defenderStatus.RealTimeProtectionEnabled) {
        Write-Host "  ‚è≥ Iniciando escaneo r√°pido..." -ForegroundColor Yellow
        
        Start-MpScan -ScanType QuickScan -ErrorAction Stop
        
        Write-Host "  ‚úÖ Escaneo completado" -ForegroundColor Green
        
        # Verificar amenazas detectadas
        $threats = Get-MpThreat
        if ($threats) {
            Write-Host "  ‚ö†Ô∏è  Amenazas detectadas por Defender: $($threats.Count)" -ForegroundColor Yellow
            foreach ($threat in $threats) {
                Write-Host "     ‚Ä¢ $($threat.ThreatName) - Severidad: $($threat.SeverityID)" -ForegroundColor Red
            }
        } else {
            Write-Host "  ‚úÖ No se detectaron amenazas" -ForegroundColor Green
        }
        
        Write-Log "Escaneo de Defender completado" -Level "SUCCESS"
        
    } else {
        Write-Host "  ‚ö†Ô∏è  Windows Defender desactivado, no se puede escanear" -ForegroundColor Yellow
        Write-Log "Defender desactivado, escaneo omitido" -Level "WARNING"
    }
} catch {
    Write-Host "  ‚ö†Ô∏è  Error al ejecutar escaneo de Defender" -ForegroundColor Yellow
    Write-Log "Error en escaneo Defender: $($_.Exception.Message)" -Level "WARNING"
}

Write-Host ""

# ============================================
# RESUMEN
# ============================================

Write-Host "========================================" -ForegroundColor Cyan
Write-Host "RESUMEN DE LIMPIEZA" -ForegroundColor Cyan
Write-Host "========================================" -ForegroundColor Cyan
Write-Host ""

if ($threatsFound -eq 0) {
    Write-Host "‚úÖ EXCELENTE: No se detectaron amenazas" -ForegroundColor Green
} elseif ($threatsFound -le 5) {
    Write-Host "‚ö†Ô∏è  ATENCI√ìN: Se detectaron algunas amenazas potenciales" -ForegroundColor Yellow
} else {
    Write-Host "‚ùå ALERTA: M√∫ltiples amenazas detectadas" -ForegroundColor Red
}

Write-Host ""
Write-Host "  ‚Ä¢ Amenazas detectadas: $threatsFound" -ForegroundColor Yellow
Write-Host "  ‚Ä¢ Elementos limpiados: $itemsCleaned" -ForegroundColor Green

Write-Host ""
Write-Host "üí° RECOMENDACIONES:" -ForegroundColor Cyan
Write-Host "  ‚Ä¢ Ejecuta un escaneo completo con Windows Defender" -ForegroundColor White
Write-Host "  ‚Ä¢ Considera usar Malwarebytes o AdwCleaner" -ForegroundColor White
Write-Host "  ‚Ä¢ Revisa manualmente las extensiones del navegador" -ForegroundColor White
Write-Host "  ‚Ä¢ Mant√©n Windows y Defender actualizados" -ForegroundColor White

Write-Log "Limpieza de malware completada: $threatsFound amenazas, $itemsCleaned limpiados" -Level "SUCCESS"

Write-Host ""
Write-Host "========================================" -ForegroundColor Cyan
Write-Host ""

Write-Host "Presiona Enter para salir..." -ForegroundColor Gray
Read-Host
